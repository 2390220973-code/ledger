<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>è®°è´¦æœ¬ Proï¼ˆç¦»çº¿ç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --btn:#111827; --btn2:#2563eb; --danger:#dc2626; --ok:#16a34a;
      --shadow:0 10px 25px rgba(17,24,39,.08); --radius:16px;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2a44;
      --btn:#e5e7eb; --btn2:#60a5fa; --danger:#f87171; --ok:#34d399;
      --shadow:0 10px 25px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC","Microsoft YaHei", Arial;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .wrap{max-width:1100px;margin:0 auto;display:grid;gap:14px}
    h1{margin:0 0 6px;font-size:20px;letter-spacing:.2px;display:flex;align-items:center;gap:10px}
    .badge{font-size:12px;padding:4px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:rgba(255,255,255,.4)}
    [data-theme="dark"] .badge{background:rgba(255,255,255,.03)}
    .grid{display:grid;gap:14px}
    @media (min-width:920px){.grid{grid-template-columns: 420px 1fr;}}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:14px;
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    input, select, textarea{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--line);
      background:transparent; color:var(--text); outline:none;
    }
    textarea{min-height:44px; resize:vertical}
    input::placeholder, textarea::placeholder{color:var(--muted)}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 14px;border-radius:14px;border:1px solid var(--line);
      background:transparent;color:var(--text);cursor:pointer;user-select:none;
      font-weight:650;
    }
    .btn.primary{background:var(--btn2);border-color:transparent;color:white}
    .btn.dark{background:var(--btn);border-color:transparent;color:var(--bg)}
    .btn.danger{background:var(--danger);border-color:transparent;color:white}
    .btn.ok{background:var(--ok);border-color:transparent;color:white}
    .btn:active{transform:translateY(1px)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .kpis{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .kpi{border:1px solid var(--line);border-radius:14px;padding:10px;background:rgba(255,255,255,.4)}
    [data-theme="dark"] .kpi{background:rgba(255,255,255,.03)}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:800;margin-top:3px}
    .pillbar{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      font-size:12px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      cursor:pointer;user-select:none;background:rgba(255,255,255,.4)
    }
    [data-theme="dark"] .pill{background:rgba(255,255,255,.03)}
    .pill:hover{filter:brightness(1.02)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);font-size:13px;vertical-align:top}
    th{color:var(--muted);font-weight:700;text-align:left}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .typeTag{
      font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);display:inline-block
    }
    .in{color:var(--ok)}
    .out{color:var(--danger)}
    .mini{font-size:12px;color:var(--muted)}
    .split{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .dangerZone{border:1px dashed var(--danger);border-radius:14px;padding:12px}
    .hint{font-size:12px;color:var(--muted);line-height:1.5}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(17,24,39,.92);color:white;padding:10px 14px;border-radius:999px;
      font-size:13px;opacity:0;pointer-events:none;transition:.2s;
    }
    [data-theme="dark"] .toast{background:rgba(229,231,235,.12)}
    .toast.show{opacity:1}
    .link{color:var(--btn2);cursor:pointer;text-decoration:underline}
    .smallbtn{padding:8px 10px;border-radius:12px;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="split">
      <h1>ğŸ“’ è®°è´¦æœ¬ Pro <span class="badge">ç¦»çº¿ Â· æœ¬åœ°ä¿å­˜ Â· å¯å¯¼å‡º</span></h1>
      <div class="toolbar">
        <button class="btn smallbtn" id="themeBtn">ğŸŒ“ ä¸»é¢˜</button>
        <button class="btn smallbtn" id="installBtn" style="display:none">â• æ·»åŠ åˆ°ä¸»å±å¹•</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="kpis">
          <div class="kpi">
            <div class="t">æœ¬æœˆæ”¶å…¥</div>
            <div class="v in" id="kpiIn">0</div>
          </div>
          <div class="kpi">
            <div class="t">æœ¬æœˆæ”¯å‡º</div>
            <div class="v out" id="kpiOut">0</div>
          </div>
          <div class="kpi">
            <div class="t">æœ¬æœˆç»“ä½™</div>
            <div class="v" id="kpiNet">0</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>æ—¥æœŸ</label>
            <input type="date" id="date" />
          </div>
          <div>
            <label>ç±»å‹</label>
            <select id="type">
              <option value="out">æ”¯å‡º</option>
              <option value="in">æ”¶å…¥</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>é‡‘é¢</label>
            <input id="amount" inputmode="decimal" placeholder="ä¾‹å¦‚ï¼š28.5" />
          </div>
          <div>
            <label>åˆ†ç±»</label>
            <select id="category"></select>
          </div>
        </div>

        <label>å¤‡æ³¨</label>
        <input id="note" placeholder="å¯ä¸å¡«ï¼Œä¾‹å¦‚ï¼šå¥¶èŒ¶ / ä¹¦è´¹ / æ‰“è½¦" />

        <div class="hr"></div>

        <div class="split">
          <div class="mini">å¿«æ·æŒ‰é’®ï¼ˆç‚¹ä¸€ä¸‹å°±å¡«å¤‡æ³¨ / å¯é€‰è‡ªåŠ¨åˆ‡åˆ†ç±»ï¼‰</div>
          <button class="btn smallbtn" id="toggleDeleteBtn">ğŸ—‘ï¸ åˆ é™¤æ¨¡å¼ï¼šå…³é—­</button>
        </div>

        <div class="row">
          <div>
            <label>æ–°å¢å¿«æ·ï¼šå¤‡æ³¨æ–‡æ¡ˆ</label>
            <input id="quickText" placeholder="ä¾‹å¦‚ï¼šå¥¶èŒ¶ / æ‰“è½¦ / å¿«é€’" />
          </div>
          <div>
            <label>å¯é€‰ï¼šè‡ªåŠ¨åˆ†ç±»</label>
            <select id="quickCat"></select>
          </div>
        </div>
        <div class="toolbar">
          <button class="btn" id="addQuickBtn">â• æ·»åŠ </button>
          <button class="btn" id="resetQuickBtn">â™»ï¸ é‡ç½®å¿«æ·</button>
        </div>

        <label>å¿«æ·åŒº</label>
        <div class="pillbar" id="quickBar"></div>

        <div class="hr"></div>

        <div class="split">
          <div>
            <div class="mini">å¸¸ç”¨å¤‡æ³¨è¯ï¼ˆè‡ªåŠ¨è¯†åˆ«ï¼šä½ è®°å¾—è¶Šå¤šè¶Šå‡†ï¼‰</div>
            <div class="hint">ç‚¹ä¸€ä¸‹æ’å…¥/è¿½åŠ ï¼›å³è¾¹å¯ä¸€é”®é‡ç½®è¯åº“ã€‚</div>
          </div>
          <button class="btn" id="resetLexBtn">ğŸ§¹ é‡ç½®è¯åº“</button>
        </div>
        <div class="pillbar" id="lexBar"></div>

        <div class="hr"></div>

        <div class="toolbar">
          <button class="btn primary" id="addBtn">âœ… è®°ä¸€ç¬”</button>
          <button class="btn" id="clearInputBtn">æ¸…ç©ºè¾“å…¥</button>
        </div>

        <div class="hr"></div>

        <label>ç­›é€‰æœˆä»½</label>
        <select id="monthFilter"></select>

        <div class="row">
          <div>
            <label>ç­›é€‰ç±»å‹</label>
            <select id="typeFilter">
              <option value="all">å…¨éƒ¨</option>
              <option value="out">æ”¯å‡º</option>
              <option value="in">æ”¶å…¥</option>
            </select>
          </div>
          <div>
            <label>ç­›é€‰åˆ†ç±»</label>
            <select id="catFilter"></select>
          </div>
        </div>

        <label>å…³é”®è¯ï¼ˆå¤‡æ³¨é‡Œæœï¼‰</label>
        <input id="kw" placeholder="æ¯”å¦‚ï¼šå½“å½“ / å¿«é€’ / å¥¶èŒ¶" />

        <div class="toolbar">
          <button class="btn" id="clearFilterBtn">æ¸…ç©ºç­›é€‰</button>
          <button class="btn ok" id="exportCsvBtn">å¯¼å‡º CSV</button>
          <button class="btn" id="backupJsonBtn">å¤‡ä»½ JSON</button>
        </div>

        <label>å¯¼å…¥ JSONï¼ˆæ¢å¤/è¿ç§»ï¼‰</label>
        <input type="file" id="importFile" accept="application/json" />

        <div class="hr"></div>

        <div class="dangerZone">
          <div class="split">
            <div>
              <div style="font-weight:800">å±é™©æ“ä½œ</div>
              <div class="hint">æ¸…ç©ºæ‰€æœ‰æ•°æ®ä¸å¯æ¢å¤ï¼Œé™¤éä½ æœ‰ JSON å¤‡ä»½ã€‚</div>
            </div>
            <button class="btn danger" id="wipeBtn">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
          </div>
        </div>

        <div class="hint" style="margin-top:10px">
          âœ… æ•°æ®ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼ˆlocalStorageï¼‰ã€‚<br/>
          âœ… æƒ³åƒ App ä¸€æ ·ç”¨ï¼šSafari æ‰“å¼€å â†’ åˆ†äº« â†’ â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ã€‚<br/>
          âœ… å¦‚æœä½ ç”¨å¤šä¸ªè®¾å¤‡ï¼šæ¯å°è®¾å¤‡æ•°æ®äº’ä¸å½±å“ï¼Œéœ€è¦å¯¼å…¥/å¯¼å‡ºåŒæ­¥ã€‚
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="split">
          <div>
            <div style="font-size:14px;font-weight:900">è®°å½•åˆ—è¡¨</div>
            <div class="mini"><span id="countText">0</span> æ¡ Â· <span class="muted">é•¿æŒ‰/å³é”®å¿«æ·æŒ‰é’®å¯åˆ é™¤ï¼ˆæ¡Œé¢ï¼‰ï¼Œæ‰‹æœºç”¨â€œåˆ é™¤æ¨¡å¼â€ã€‚</span></div>
          </div>
          <div class="mini"><span class="link" id="scrollTop">å›åˆ°é¡¶éƒ¨</span></div>
        </div>

        <div class="hr"></div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th style="min-width:110px">æ—¥æœŸ</th>
                <th style="min-width:76px">ç±»å‹</th>
                <th style="min-width:92px">åˆ†ç±»</th>
                <th class="right" style="min-width:92px">é‡‘é¢</th>
                <th>å¤‡æ³¨</th>
                <th style="min-width:88px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
(() => {
  // ---------- Storage ----------
  const LS_KEY = "ledger_pro_v1";
  const LS_CFG = "ledger_pro_cfg_v1";

  const now = new Date();
  const pad = n => String(n).padStart(2,"0");
  const todayISO = () => `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
  const ym = (d) => d.slice(0,7);

  // ---------- Defaults ----------
  const defaultCats = [
    "é¤é¥®","äº¤é€š","æ—¥ç”¨","è´­ç‰©","æˆ¿ç§Ÿ/æ°´ç”µ","å¨±ä¹","åŒ»ç–—","å­¦ä¹ ","äººæƒ…","å® ç‰©","æ—…è¡Œ","å…¶ä»–"
  ];
  const defaultQuick = [
    {text:"å¥¶èŒ¶", cat:"é¤é¥®"},
    {text:"æ‰“è½¦", cat:"äº¤é€š"},
    {text:"å¤–å–", cat:"é¤é¥®"},
    {text:"å¿«é€’", cat:"æ—¥ç”¨"},
    {text:"ä¹°ä¹¦", cat:"å­¦ä¹ "},
    {text:"ç”µå½±", cat:"å¨±ä¹"},
  ];
  const defaultLexSeed = ["å¥¶èŒ¶","æ‰“è½¦","å¤–å–","å¿«é€’","å’–å•¡","æ—©é¤","åˆé¤","æ™šé¤","ä¹°ä¹¦","è¯è´¹","åœ°é“","å…¬äº¤"];

  // ---------- DOM ----------
  const $ = s => document.querySelector(s);
  const dateEl = $("#date");
  const typeEl = $("#type");
  const amountEl = $("#amount");
  const noteEl = $("#note");
  const catEl = $("#category");
  const monthFilterEl = $("#monthFilter");
  const typeFilterEl = $("#typeFilter");
  const catFilterEl = $("#catFilter");
  const kwEl = $("#kw");
  const tbody = $("#tbody");

  const kpiIn = $("#kpiIn");
  const kpiOut = $("#kpiOut");
  const kpiNet = $("#kpiNet");
  const countText = $("#countText");

  const quickBar = $("#quickBar");
  const lexBar = $("#lexBar");
  const quickTextEl = $("#quickText");
  const quickCatEl = $("#quickCat");
  const addQuickBtn = $("#addQuickBtn");
  const resetQuickBtn = $("#resetQuickBtn");
  const resetLexBtn = $("#resetLexBtn");
  const addBtn = $("#addBtn");
  const clearInputBtn = $("#clearInputBtn");
  const clearFilterBtn = $("#clearFilterBtn");
  const exportCsvBtn = $("#exportCsvBtn");
  const backupJsonBtn = $("#backupJsonBtn");
  const importFile = $("#importFile");
  const wipeBtn = $("#wipeBtn");
  const toggleDeleteBtn = $("#toggleDeleteBtn");
  const themeBtn = $("#themeBtn");
  const installBtn = $("#installBtn");
  const toast = $("#toast");
  const scrollTop = $("#scrollTop");

  // ---------- Toast ----------
  let toastTimer = null;
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toast.classList.remove("show"), 1200);
  }

  // ---------- Config ----------
  function loadCfg(){
    try{
      return JSON.parse(localStorage.getItem(LS_CFG) || "{}");
    }catch(e){ return {}; }
  }
  function saveCfg(cfg){
    localStorage.setItem(LS_CFG, JSON.stringify(cfg));
  }

  let cfg = loadCfg();
  if(!cfg.cats) cfg.cats = defaultCats.slice();
  if(!cfg.quick) cfg.quick = defaultQuick.slice();
  if(!cfg.lex) cfg.lex = {}; // word -> count
  if(!cfg.theme) cfg.theme = "auto";
  if(typeof cfg.deleteMode !== "boolean") cfg.deleteMode = false;

  // Seed lexicon if empty
  if(Object.keys(cfg.lex).length === 0){
    defaultLexSeed.forEach(w => cfg.lex[w] = (cfg.lex[w]||0)+1);
  }

  // ---------- Data ----------
  function loadData(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : [];
    }catch(e){ return []; }
  }
  function saveData(list){
    localStorage.setItem(LS_KEY, JSON.stringify(list));
  }
  let data = loadData(); // [{id, date, type, cat, amount, note, ts}]

  // ---------- Theme ----------
  function applyTheme(){
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    let theme = cfg.theme;
    if(theme === "auto") theme = prefersDark ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", theme === "dark" ? "dark" : "light");
    showToast(theme === "dark" ? "å·²åˆ‡æ¢ï¼šæš—è‰²" : "å·²åˆ‡æ¢ï¼šäº®è‰²");
  }
  function cycleTheme(){
    cfg.theme = cfg.theme === "auto" ? "dark" : (cfg.theme === "dark" ? "light" : "auto");
    saveCfg(cfg);
    const map = {auto:"è‡ªåŠ¨",dark:"æš—è‰²",light:"äº®è‰²"};
    showToast(`ä¸»é¢˜ï¼š${map[cfg.theme]}`);
    applyTheme();
  }

  // ---------- Select options ----------
  function fillCats(){
    const fill = (sel, includeAll=false) => {
      sel.innerHTML = "";
      if(includeAll){
        const o = document.createElement("option");
        o.value = "all"; o.textContent = "å…¨éƒ¨";
        sel.appendChild(o);
      }
      cfg.cats.forEach(c=>{
        const o = document.createElement("option");
        o.value = c; o.textContent = c;
        sel.appendChild(o);
      });
    };
    fill(catEl,false);
    fill(quickCatEl,true);
    fill(catFilterEl,true);

    // default select
    if(!catEl.value) catEl.value = cfg.cats[0] || "å…¶ä»–";
    if(quickCatEl.value === "") quickCatEl.value = "all";
    if(catFilterEl.value === "") catFilterEl.value = "all";
  }

  function fillMonths(){
    const months = Array.from(new Set(data.map(x=>ym(x.date)))).sort().reverse();
    const cur = ym(todayISO());
    if(months.length === 0) months.push(cur);
    if(!months.includes(cur)) months.unshift(cur);

    monthFilterEl.innerHTML = "";
    const allOpt = document.createElement("option");
    allOpt.value = "all"; allOpt.textContent = "å…¨éƒ¨æœˆä»½";
    monthFilterEl.appendChild(allOpt);
    months.forEach(m=>{
      const o = document.createElement("option");
      o.value = m; o.textContent = m;
      monthFilterEl.appendChild(o);
    });
    if(!monthFilterEl.value) monthFilterEl.value = cur; // é»˜è®¤æœ¬æœˆ
  }

  // ---------- Helpers ----------
  const money = n => {
    const v = Number(n || 0);
    return (Math.round(v*100)/100).toFixed(2);
  };
  function parseAmount(str){
    if(str == null) return null;
    const s = String(str).replace(/[^\d.]/g,"").trim();
    if(!s) return null;
    const v = Number(s);
    if(!Number.isFinite(v) || v <= 0) return null;
    return Math.round(v*100)/100;
  }
  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  // ---------- Quick buttons ----------
  function renderQuick(){
    quickBar.innerHTML = "";
    cfg.quick.forEach((q, idx)=>{
      const pill = document.createElement("div");
      pill.className = "pill";
      pill.textContent = q.text + (q.cat ? ` Â· ${q.cat}` : "");
      pill.title = "ç‚¹ä¸€ä¸‹æ’å…¥å¤‡æ³¨ï¼›é•¿æŒ‰/å³é”®åˆ é™¤";
      pill.onclick = () => {
        if(cfg.deleteMode){
          cfg.quick.splice(idx,1);
          saveCfg(cfg);
          renderQuick();
          showToast("å·²åˆ é™¤å¿«æ·");
          return;
        }
        // insert/append note
        const cur = noteEl.value.trim();
        noteEl.value = cur ? (cur + " / " + q.text) : q.text;
        noteEl.focus();
        if(q.cat && q.cat !== "all"){
          catEl.value = q.cat;
        }
      };
      // desktop right click / long press
      pill.oncontextmenu = (e) => {
        e.preventDefault();
        cfg.quick.splice(idx,1);
        saveCfg(cfg);
        renderQuick();
        showToast("å·²åˆ é™¤å¿«æ·");
      };
      let pressTimer = null;
      pill.ontouchstart = () => {
        pressTimer = setTimeout(()=>{
          cfg.quick.splice(idx,1);
          saveCfg(cfg);
          renderQuick();
          showToast("å·²åˆ é™¤å¿«æ·");
        }, 650);
      };
      pill.ontouchend = () => clearTimeout(pressTimer);
      quickBar.appendChild(pill);
    });
    if(cfg.quick.length === 0){
      const tip = document.createElement("div");
      tip.className="hint";
      tip.textContent="è¿˜æ²¡æœ‰å¿«æ·æŒ‰é’®ï¼Œå…ˆæ·»åŠ å‡ ä¸ªå¸¸ç”¨çš„ã€‚";
      quickBar.appendChild(tip);
    }
  }

  function addQuick(){
    const text = quickTextEl.value.trim();
    const cat = quickCatEl.value;
    if(!text){ showToast("å…ˆå†™å¿«æ·æ–‡æ¡ˆ"); return; }
    // dedupe
    if(cfg.quick.some(x=>x.text===text)){ showToast("è¿™ä¸ªå¿«æ·å·²å­˜åœ¨"); return; }
    cfg.quick.unshift({text, cat: cat==="all" ? "" : cat});
    quickTextEl.value="";
    saveCfg(cfg);
    renderQuick();
    showToast("å·²æ·»åŠ å¿«æ·");
  }

  function resetQuick(){
    cfg.quick = defaultQuick.slice();
    saveCfg(cfg);
    renderQuick();
    showToast("å·²é‡ç½®å¿«æ·");
  }

  // ---------- Lexicon ----------
  function bumpLexFromNote(note){
    if(!note) return;
    // Split by common separators, keep short phrases
    const parts = note
      .split(/[\s/ã€,ï¼Œ;ï¼›|]+/g)
      .map(s=>s.trim())
      .filter(Boolean);

    parts.forEach(p=>{
      // normalize
      const w = p.slice(0,20);
      if(!w) return;
      cfg.lex[w] = (cfg.lex[w]||0) + 1;
    });
    saveCfg(cfg);
  }

  function topLex(n=12){
    return Object.entries(cfg.lex)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,n)
      .map(([w,c])=>({w,c}));
  }

  function autoCategoryFromNote(note){
    const s = (note||"").toLowerCase();
    // very simple keyword mapping; you can extend later
    const rules = [
      {k:["å¥¶èŒ¶","å’–å•¡","å¤–å–","ç«é”…","çƒ§çƒ¤","æ—©é¤","åˆé¤","æ™šé¤","åƒ","é¥­"], cat:"é¤é¥®"},
      {k:["æ‰“è½¦","æ»´æ»´","åœ°é“","å…¬äº¤","è½¦è´¹","æ²¹è´¹","åœè½¦"], cat:"äº¤é€š"},
      {k:["å¿«é€’","çº¸","æ´—å‘","æ²æµ´","ç‰™è†","æ—¥ç”¨"], cat:"æ—¥ç”¨"},
      {k:["ä¹°ä¹¦","ä¹¦è´¹","è¯¾ç¨‹","ç½‘è¯¾","æŠ¥å","è€ƒè¯•"], cat:"å­¦ä¹ "},
      {k:["è¯","åŒ»é™¢","æŒ‚å·","ä½“æ£€"], cat:"åŒ»ç–—"},
      {k:["ç”µå½±","æ¸¸æˆ","æ¼”å”±ä¼š","KTV"], cat:"å¨±ä¹"},
      {k:["æˆ¿ç§Ÿ","æ°´ç”µ","ç”µè´¹","æ°´è´¹","ç‡ƒæ°”"], cat:"æˆ¿ç§Ÿ/æ°´ç”µ"},
    ];
    for(const r of rules){
      if(r.k.some(x=>s.includes(String(x).toLowerCase()))){
        return r.cat;
      }
    }
    return null;
  }

  function renderLex(){
    lexBar.innerHTML = "";
    const list = topLex(12);
    list.forEach(({w,c})=>{
      const pill = document.createElement("div");
      pill.className="pill";
      pill.textContent = `${w} Â· ${c}`;
      pill.title = "ç‚¹ä¸€ä¸‹æ’å…¥/è¿½åŠ åˆ°å¤‡æ³¨";
      pill.onclick = () => {
        const cur = noteEl.value.trim();
        noteEl.value = cur ? (cur + " / " + w) : w;
        noteEl.focus();
      };
      lexBar.appendChild(pill);
    });

    const tip = document.createElement("div");
    tip.className="hint";
    tip.innerHTML = `Top è¯ï¼šæŒ‰å¤‡æ³¨ç»Ÿè®¡ï¼ˆè¶Šè®°è¶Šå‡†ï¼‰ã€‚`;
    lexBar.appendChild(tip);
  }

  function resetLex(){
    cfg.lex = {};
    defaultLexSeed.forEach(w => cfg.lex[w] = (cfg.lex[w]||0)+1);
    saveCfg(cfg);
    renderLex();
    showToast("å·²é‡ç½®è¯åº“");
  }

  // ---------- Add record ----------
  function clearInput(){
    amountEl.value="";
    noteEl.value="";
    catEl.value = cfg.cats[0] || "å…¶ä»–";
    typeEl.value = "out";
    dateEl.value = todayISO();
  }

  function addRecord(){
    const date = dateEl.value || todayISO();
    const type = typeEl.value;
    const amount = parseAmount(amountEl.value);
    if(!amount){ showToast("é‡‘é¢æ²¡å¡«å¯¹"); return; }

    let cat = catEl.value || "å…¶ä»–";
    let note = noteEl.value.trim();

    // auto category (only when note exists & user didn't manually change? We'll keep simple)
    if(note){
      const ac = autoCategoryFromNote(note);
      if(ac && cfg.cats.includes(ac)){
        cat = ac;
        catEl.value = ac;
      }
    }

    const item = {
      id: uid(),
      date,
      type,
      cat,
      amount,
      note,
      ts: Date.now()
    };
    data.unshift(item);
    saveData(data);

    // learn lexicon from note
    bumpLexFromNote(note);

    // update UI
    fillMonths();
    render();
    renderLex();
    showToast("å·²è®°å½•");
    amountEl.value="";
    noteEl.value="";
    amountEl.focus();
  }

  // ---------- Filters & render ----------
  function getFiltered(){
    const m = monthFilterEl.value;
    const tf = typeFilterEl.value;
    const cf = catFilterEl.value;
    const kw = (kwEl.value||"").trim().toLowerCase();

    return data.filter(x=>{
      if(m !== "all" && ym(x.date) !== m) return false;
      if(tf !== "all" && x.type !== tf) return false;
      if(cf !== "all" && x.cat !== cf) return false;
      if(kw){
        const bag = `${x.note||""} ${x.cat||""}`.toLowerCase();
        if(!bag.includes(kw)) return false;
      }
      return true;
    });
  }

  function computeMonthKpis(month){
    const list = data.filter(x=>ym(x.date)===month);
    const inc = list.filter(x=>x.type==="in").reduce((s,x)=>s+x.amount,0);
    const out = list.filter(x=>x.type==="out").reduce((s,x)=>s+x.amount,0);
    return {inc,out,net:inc-out};
  }

  function render(){
    const list = getFiltered();
    countText.textContent = list.length;

    tbody.innerHTML = "";
    list.forEach(x=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.date}</td>
        <td><span class="typeTag ${x.type==="in"?"in":"out"}">${x.type==="in"?"æ”¶å…¥":"æ”¯å‡º"}</span></td>
        <td>${x.cat || "-"}</td>
        <td class="right ${x.type==="in"?"in":"out"}">${x.type==="in"?"+":"-"}${money(x.amount)}</td>
        <td class="muted">${escapeHtml(x.note || "")}</td>
        <td>
          <button class="btn smallbtn danger" data-del="${x.id}">åˆ é™¤</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // bind delete
    tbody.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = () => {
        const id = btn.getAttribute("data-del");
        data = data.filter(x=>x.id !== id);
        saveData(data);
        fillMonths();
        render();
        showToast("å·²åˆ é™¤");
      };
    });

    // kpi is for selected month if monthFilter is a month else current month
    const curMonth = ym(todayISO());
    const kMonth = (monthFilterEl.value && monthFilterEl.value !== "all") ? monthFilterEl.value : curMonth;
    const {inc,out,net} = computeMonthKpis(kMonth);
    kpiIn.textContent = money(inc);
    kpiOut.textContent = money(out);
    kpiNet.textContent = money(net);
    kpiNet.className = "v" + (net>=0 ? " in" : " out");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- CSV / JSON ----------
  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportCSV(){
    const list = getFiltered();
    const head = ["date","type","category","amount","note"];
    const rows = list.map(x=>[
      x.date,
      x.type==="in"?"income":"expense",
      x.cat||"",
      money(x.amount),
      (x.note||"").replaceAll('"','""')
    ]);
    const csv = [head.join(","), ...rows.map(r=>`${r[0]},${r[1]},${r[2]},${r[3]},"${r[4]}"`)].join("\n");
    downloadBlob(new Blob([csv],{type:"text/csv;charset=utf-8"}), `ledger_${Date.now()}.csv`);
    showToast("å·²å¯¼å‡º CSV");
  }

  function backupJSON(){
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      data,
      cfg
    };
    downloadBlob(new Blob([JSON.stringify(payload,null,2)],{type:"application/json"}), `ledger_backup_${Date.now()}.json`);
    showToast("å·²å¤‡ä»½ JSON");
  }

  function importJSON(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(reader.result);
        if(obj && obj.data && Array.isArray(obj.data)){
          data = obj.data;
          saveData(data);
        }
        if(obj && obj.cfg){
          cfg = obj.cfg;
          // ensure fields exist
          if(!cfg.cats) cfg.cats = defaultCats.slice();
          if(!cfg.quick) cfg.quick = defaultQuick.slice();
          if(!cfg.lex) cfg.lex = {};
          if(!cfg.theme) cfg.theme = "auto";
          if(typeof cfg.deleteMode !== "boolean") cfg.deleteMode = false;
          saveCfg(cfg);
        }
        initUI();
        showToast("å·²å¯¼å…¥å®Œæˆ");
      }catch(e){
        showToast("å¯¼å…¥å¤±è´¥ï¼šJSON ä¸å¯¹");
      }
    };
    reader.readAsText(file);
  }

  // ---------- Delete mode ----------
  function syncDeleteModeBtn(){
    toggleDeleteBtn.textContent = `ğŸ—‘ï¸ åˆ é™¤æ¨¡å¼ï¼š${cfg.deleteMode ? "å¼€å¯" : "å…³é—­"}`;
    toggleDeleteBtn.className = "btn smallbtn " + (cfg.deleteMode ? "danger" : "");
  }

  function toggleDeleteMode(){
    cfg.deleteMode = !cfg.deleteMode;
    saveCfg(cfg);
    syncDeleteModeBtn();
    showToast(cfg.deleteMode ? "åˆ é™¤æ¨¡å¼å·²å¼€å¯" : "åˆ é™¤æ¨¡å¼å·²å…³é—­");
  }

  // ---------- PWA install (in-page) ----------
  let deferredPrompt = null;
  window.addEventListener("beforeinstallprompt", (e)=>{
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = "inline-flex";
  });
  installBtn.addEventListener("click", async ()=>{
    if(!deferredPrompt){ showToast("è¯·ç”¨ Safari åˆ†äº«â†’æ·»åŠ åˆ°ä¸»å±å¹•"); return; }
    deferredPrompt.prompt();
    deferredPrompt = null;
    installBtn.style.display = "none";
  });

  // ---------- Service worker (offline) ----------
  // We'll create a SW from a Blob so this single file can be fully offline.
  async function registerSW(){
    if(!("serviceWorker" in navigator)) return;
    const swCode = `
      const CACHE = "ledger-pro-cache-v1";
      self.addEventListener("install", (e) => {
        e.waitUntil(
          caches.open(CACHE).then(c => c.addAll(["./"]))
        );
        self.skipWaiting();
      });
      self.addEventListener("activate", (e) => {
        e.waitUntil(self.clients.claim());
      });
      self.addEventListener("fetch", (e) => {
        e.respondWith(
          caches.match(e.request).then(res => res || fetch(e.request).then(net => {
            const copy = net.clone();
            caches.open(CACHE).then(c => c.put(e.request, copy)).catch(()=>{});
            return net;
          }).catch(()=>res))
        );
      });
    `;
    const blob = new Blob([swCode], {type:"text/javascript"});
    const swUrl = URL.createObjectURL(blob);
    try{
      await navigator.serviceWorker.register(swUrl, {scope:"./"});
    }catch(e){
      // ignore
    }
  }

  // ---------- Events ----------
  addBtn.addEventListener("click", addRecord);
  clearInputBtn.addEventListener("click", ()=>{ clearInput(); showToast("å·²æ¸…ç©ºè¾“å…¥"); });
  addQuickBtn.addEventListener("click", addQuick);
  resetQuickBtn.addEventListener("click", resetQuick);
  resetLexBtn.addEventListener("click", resetLex);

  monthFilterEl.addEventListener("change", render);
  typeFilterEl.addEventListener("change", render);
  catFilterEl.addEventListener("change", render);
  kwEl.addEventListener("input", ()=>{ render(); });

  clearFilterBtn.addEventListener("click", ()=>{
    monthFilterEl.value = ym(todayISO());
    typeFilterEl.value = "all";
    catFilterEl.value = "all";
    kwEl.value = "";
    render();
    showToast("å·²æ¸…ç©ºç­›é€‰");
  });

  exportCsvBtn.addEventListener("click", exportCSV);
  backupJsonBtn.addEventListener("click", backupJSON);
  importFile.addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) importJSON(f);
    importFile.value = "";
  });

  wipeBtn.addEventListener("click", ()=>{
    const ok = confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼ˆé™¤éä½ æœ‰ JSON å¤‡ä»½ï¼‰ã€‚");
    if(!ok) return;
    data = [];
    saveData(data);
    showToast("å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®");
    fillMonths();
    render();
  });

  toggleDeleteBtn.addEventListener("click", toggleDeleteMode);
  themeBtn.addEventListener("click", cycleTheme);
  scrollTop.addEventListener("click", ()=>window.scrollTo({top:0,behavior:"smooth"}));

  // handy: enter to add
  amountEl.addEventListener("keydown",(e)=>{ if(e.key==="Enter") addRecord(); });
  noteEl.addEventListener("keydown",(e)=>{ if(e.key==="Enter") addRecord(); });

  // Auto-fill date to today
  function initUI(){
    // date default
    if(!dateEl.value) dateEl.value = todayISO();

    fillCats();
    fillMonths();
    renderQuick();
    renderLex();
    syncDeleteModeBtn();
    applyTheme();
    render();

    // keep quickCat include "ä¸æ”¹å˜" option
    if(!quickCatEl.querySelector('option[value="all"]')){
      const o = document.createElement("option");
      o.value="all"; o.textContent="ä¸æ”¹å˜";
      quickCatEl.prepend(o);
    }
    if(!quickCatEl.value) quickCatEl.value="all";
  }

  initUI();
  registerSW();

})();
</script>
</body>
</html>

